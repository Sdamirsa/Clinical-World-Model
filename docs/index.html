<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical World Model | 8-Dimension Framework (5C + 3A)</title>
    <meta name="description" content="Clinical World Model: 8-dimension framework with Clinical Competency (5C) and AI Engagement (3A) cubes for healthcare AI evaluation">
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/lucide@0.263.1/dist/umd/lucide.js" rel="stylesheet">

    <!-- Decision Making Styles -->
    <style>

        .framework-quote {
            margin: 12px 0 0 0;
            padding: 14px 18px;
            background: rgba(15, 23, 42, 0.08);
            border-left: 6px solid white;
            border-right: 6px solid white;
            border-radius: 6px;
            color: #374151;
            font-style: italic;
            line-height: 1.5;
            text-align: left; 
        }
        .framework-quote p { margin: 0; }
        .framework-quote ul { margin: 8px 0 0 18px; padding: 0; list-style: disc; font-style: normal; color: #374151; }
        .framework-quote li { margin-bottom: 6px; }

        /* Decision Making Section Specific Styles */
        .decision-making-section {
            position: relative;
            padding: var(--spacing-xl, 2rem) 0;
            background: linear-gradient(180deg, var(--gray-50, #f9fafb) 0%, #f5f0ff 25%, #f0f9ff 75%, var(--gray-50, #f9fafb) 100%);
            overflow: hidden;
            min-height: 100vh;
            width: 100%;
        }

        .decision-making-section::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 50% at 20% 20%, rgba(192, 38, 211, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse 80% 50% at 80% 80%, rgba(14, 165, 233, 0.08) 0%, transparent 50%);
            pointer-events: none;
        }

        .decision-making-section .section-container {
            position: relative;
            z-index: 1;
        }

        .decision-making-section .section-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm, 0.5rem);
            font-size: 0.8125rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #8b5cf6;
            margin-bottom: var(--spacing-lg, 1.5rem);
            padding: var(--spacing-sm, 0.5rem) var(--spacing-lg, 1.5rem);
            background: linear-gradient(135deg, rgba(192, 38, 211, 0.1), rgba(14, 165, 233, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 9999px;
        }

        .decision-making-section .section-badge svg { width: 16px; height: 16px; }

        .decision-making-section .section-title {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: clamp(2.5rem, 5vw, 4.5rem);
            font-weight: 600;
            color: var(--gray-900, #111827);
            line-height: 1.15;
            margin-bottom: var(--spacing-lg, 1.5rem);
        }

        .decision-making-section .gradient-text {
            background: linear-gradient(135deg, #c026d3, #8b5cf6, #0ea5e9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .decision-making-section .section-subtitle {
            font-size: 1.125rem;
            color: var(--gray-600, #4b5563);
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.75;
        }

        .decision-making-section .section-subtitle strong { color: var(--gray-700, #374151); font-weight: 600; }

        .control-panel {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-md, 1rem);
            margin-bottom: var(--spacing-lg, 1.5rem);
            flex-wrap: wrap;
            padding: 0 var(--spacing-md, 1rem);
        }

        .control-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm, 0.5rem);
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--gray-200, #e5e7eb);
            border-radius: 9999px;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700, #374151);
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .control-btn:hover {
            border-color: #8b5cf6;
            color: #8b5cf6;
            background: rgba(139, 92, 246, 0.05);
            transform: translateY(-1px);
        }

        .control-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #c026d3);
            border-color: transparent;
            color: white;
        }

        .control-btn svg { width: 18px; height: 18px; }

        .speed-control {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm, 0.5rem);
            padding: 8px 16px;
            background: white;
            border: 2px solid var(--gray-200, #e5e7eb);
            border-radius: 9999px;
        }

        .speed-control label { font-size: 0.8125rem; font-weight: 600; color: var(--gray-600, #4b5563); }
        .speed-control input[type="range"] { width: 80px; cursor: pointer; accent-color: #8b5cf6; }

        .visualization-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md, 1rem);
            margin-bottom: var(--spacing-xl, 2rem);
            align-items: start;
            width: 100%;
        }

        @media (max-width: 1100px) {
            .visualization-grid { grid-template-columns: 1fr; gap: var(--spacing-xl, 2rem); }
        }

        .decision-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.4s ease;
            position: relative;
        }

        .decision-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            z-index: 10;
        }

        .decision-card.cdm-card::before {
            background: linear-gradient(90deg, #c026d3, #a855f7, #7c3aed);
        }

        .decision-card.pdm-card::before {
            background: linear-gradient(90deg, #0ea5e9, #06b6d4, #0891b2);
        }

        .decision-card:hover { transform: translateY(-6px); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

        .card-header {
            padding: var(--spacing-xl, 2rem) var(--spacing-xl, 2rem) var(--spacing-lg, 1.5rem);
            border-bottom: 1px solid var(--gray-100, #f3f4f6);
        }

        .card-header.cdm-header { background: linear-gradient(180deg, #fae8ff, rgba(250, 232, 255, 0.3)); }
        .card-header.pdm-header { background: linear-gradient(180deg, #e0f2fe, rgba(224, 242, 254, 0.3)); }

        .card-title-row { display: flex; align-items: center; gap: var(--spacing-md, 1rem); margin-bottom: var(--spacing-sm, 0.5rem); }

        .card-icon {
            width: 52px;
            height: 52px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .cdm-card .card-icon { background: linear-gradient(135deg, #c026d3, #7c3aed); }
        .pdm-card .card-icon { background: linear-gradient(135deg, #0ea5e9, #0891b2); }
        .card-icon svg { width: 26px; height: 26px; }

        .card-title {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--gray-900, #111827);
        }

        .card-description { font-size: 0.9375rem; color: var(--gray-500, #6b7280); line-height: 1.5; }

        .card-body { padding: var(--spacing-md, 1rem); background: linear-gradient(180deg, var(--gray-50, #f9fafb), white); }

        .flow-canvas {
            position: relative;
            width: 100%;
            height: 850px;
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid var(--gray-100, #f3f4f6);
        }

        .flow-svg { width: 100%; height: 100%; }

        .status-bar {
            position: absolute;
            top: var(--spacing-md, 1rem);
            left: var(--spacing-md, 1rem);
            right: var(--spacing-md, 1rem);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .loop-counter, .current-stage {
            background: white;
            border-radius: 0.75rem;
            padding: 8px 14px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm, 0.5rem);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-700, #374151);
            border: 1px solid var(--gray-100, #f3f4f6);
        }

        .loop-dots { display: flex; gap: 5px; }

        .loop-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--gray-200, #e5e7eb);
            transition: all 0.3s ease;
        }

        .loop-dot.active { transform: scale(1.3); }
        .cdm-card .loop-dot.active { background: #c026d3; box-shadow: 0 0 10px #c026d3; }
        .pdm-card .loop-dot.active { background: #0ea5e9; box-shadow: 0 0 10px #0ea5e9; }

        .stage-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: stagePulse 1.5s ease-in-out infinite;
        }

        .cdm-card .stage-dot { background: #c026d3; }
        .pdm-card .stage-dot { background: #0ea5e9; }

        @keyframes stagePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.7); }
        }

        .node-group { cursor: pointer; transition: filter 0.2s ease; }
        .node-group:hover { filter: brightness(1.08) drop-shadow(0 4px 8px rgba(0,0,0,0.15)); }
        .node-group.active .glow-effect { opacity: 1; animation: nodeGlow 1.2s ease-in-out infinite; }

        @keyframes nodeGlow { 0%, 100% { opacity: 0.9; } 50% { opacity: 0.4; } }

        .path-active {
            stroke: #7c3aed !important;
            stroke-width: 4 !important;
            filter: drop-shadow(0 0 4px rgba(124, 58, 237, 0.6));
            animation: pathPulse 1.5s ease-in-out infinite;
        }

        @keyframes pathPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .node-text { font-family: 'Source Sans Pro', sans-serif; pointer-events: none; user-select: none; }

        .flow-path { fill: none; stroke-linecap: round; }
        .flow-path.animated { stroke-dasharray: 8, 5; animation: flowDash 25s linear infinite; }

        @keyframes flowDash { to { stroke-dashoffset: -1000; } }

        .bidirectional-path { stroke-dasharray: 4, 3; animation: bidirectionalFlow 3s ease-in-out infinite alternate; }

        @keyframes bidirectionalFlow {
            0% { stroke-dashoffset: 0; opacity: 0.7; }
            100% { stroke-dashoffset: -20; opacity: 1; }
        }

        .center-connector { display: none; }

        .info-panels-philosophy {
            margin-bottom: var(--spacing-lg, 1.5rem);
            width: 100%;
        }

        .info-panels-split {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--spacing-md, 1rem);
            width: 100%;
        }

        .info-panel-full { width: 100%; }
        .info-panel-third { grid-column: span 1; }
        .info-panel-twothirds { grid-column: span 1; }

        .info-panel {
            background: white;
            border-radius: 1.5rem;
            padding: var(--spacing-xl, 2rem);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--gray-100, #f3f4f6);
            transition: all 0.3s ease;
        }

        .info-panel:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }

        .panel-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md, 1rem);
            margin-bottom: var(--spacing-lg, 1.5rem);
            padding-bottom: var(--spacing-md, 1rem);
            border-bottom: 1px solid var(--gray-100, #f3f4f6);
        }

        .panel-icon {
            width: 44px;
            height: 44px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-icon.legend { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #b45309; }
        .panel-icon.process { background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #7c3aed; }
        .panel-icon.philosophy { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #059669; }
        .panel-icon svg { width: 22px; height: 22px; }

        .panel-title {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800, #1f2937);
        }

        .legend-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm, 0.5rem); }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm, 0.5rem);
            padding: var(--spacing-sm, 0.5rem) var(--spacing-md, 1rem);
            border-radius: 0.5rem;
            transition: background 0.2s ease;
        }

        .legend-item:hover { background: var(--gray-50, #f9fafb); }

        .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 0.375rem;
            flex-shrink: 0;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
        }

        .legend-label { font-size: 0.8125rem; color: var(--gray-700, #374151); }

        .process-steps { display: flex; flex-direction: column; gap: var(--spacing-md, 1rem); }

        .process-step {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md, 1rem);
            padding: var(--spacing-md, 1rem);
            background: var(--gray-50, #f9fafb);
            border-radius: 0.75rem;
            border-left: 3px solid #8b5cf6;
            transition: all 0.2s ease;
        }

        .process-step:hover { background: rgba(139, 92, 246, 0.05); border-left-color: #c026d3; }

        .step-num {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #c026d3);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .step-content h4 { font-size: 0.875rem; font-weight: 600; color: var(--gray-800, #1f2937); margin-bottom: 2px; }
        .step-content p { font-size: 0.8125rem; color: var(--gray-500, #6b7280); line-height: 1.45; }

        .philosophy-quote {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 1.0625rem;
            font-style: italic;
            color: var(--gray-700, #374151);
            line-height: 1.7;
            padding: var(--spacing-md, 1rem);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(20, 184, 166, 0.05));
            border-radius: 0.75rem;
            border-left: 3px solid #14b8a6;
        }

        .philosophy-quote cite {
            display: block;
            font-size: 0.875rem;
            font-style: normal;
            font-family: 'Source Sans Pro', sans-serif;
            color: var(--gray-500, #6b7280);
            margin-top: var(--spacing-sm, 0.5rem);
        }

        .dm-tooltip {
            position: fixed;
            background: var(--gray-900, #111827);
            color: white;
            padding: var(--spacing-md, 1rem);
            border-radius: 0.75rem;
            font-size: 0.8125rem;
            max-width: 300px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: all 0.2s ease;
            z-index: 1000;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        .dm-tooltip.visible { opacity: 1; transform: translateY(0) scale(1); }
        .dm-tooltip-header { font-weight: 700; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .dm-tooltip-list { font-size: 0.75rem; opacity: 0.9; padding-left: 16px; }
        .dm-tooltip-list li { margin-bottom: 3px; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeInUp 0.7s ease forwards; }
        .delay-100 { animation-delay: 0.1s; opacity: 0; }
        .delay-200 { animation-delay: 0.2s; opacity: 0; }
        .delay-300 { animation-delay: 0.3s; opacity: 0; }

        @media (max-width: 768px) {
            .decision-making-section { padding: var(--spacing-lg, 1.5rem) 0; }
            .decision-making-section .section-title { font-size: 2.25rem; }
            .flow-canvas { height: 750px; }
            .control-panel { gap: var(--spacing-sm, 0.5rem); }
            .control-btn { padding: 8px 14px; font-size: 0.8125rem; }
            .legend-grid { grid-template-columns: 1fr; }
            .info-panels-split { grid-template-columns: 1fr; }
            .info-panels-philosophy { margin-bottom: var(--spacing-md, 1rem); }
            .visualization-grid { gap: var(--spacing-sm, 0.5rem); }
        }

        .cwm-closing {
        --cwm-text: #2c2c2c;
        --cwm-text-secondary: #555;
        --cwm-accent: #b44a3e;
        --cwm-accent-light: rgba(180, 74, 62, 0.06);
        --cwm-border: #e0d6cf;
        --cwm-bg: #fafaf8;
        --cwm-quote-bg: #f4f1ed;
        --cwm-font-body: 'Source Serif 4', 'Georgia', serif;
        --cwm-font-accent: 'DM Sans', 'Helvetica Neue', sans-serif;

        background: var(--cwm-bg);
        padding: 5rem 1.5rem;
        font-family: var(--cwm-font-body);
        color: var(--cwm-text);
        line-height: 1.8;
        border-top: 1px solid var(--cwm-border);
        }

        .cwm-closing .closing-inner {
        max-width: 720px;
        margin: 0 auto;
        }

        .cwm-closing .section-label {
        font-family: var(--cwm-font-accent);
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--cwm-accent);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        }

        .cwm-closing .section-label::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--cwm-border);
        }

        .cwm-closing .closing-body {
        font-size: 1.125rem;
        color: var(--cwm-text-secondary);
        margin-bottom: 2.5rem;
        }

        .cwm-closing .closing-body .lead-sentence {
        color: var(--cwm-text);
        font-weight: 500;
        }

        .cwm-closing .closing-body .framework-ref {
        font-weight: 600;
        color: var(--cwm-text);
        }

        .cwm-closing .closing-body .dim-tag {
        font-family: var(--cwm-font-accent);
        font-size: 0.85em;
        font-weight: 500;
        color: var(--cwm-accent);
        letter-spacing: 0.01em;
        }

        .cwm-closing .pull-quote {
        background: var(--cwm-quote-bg);
        border-left: 3px solid var(--cwm-accent);
        padding: 1.75rem 2rem;
        margin: 2.5rem 0;
        border-radius: 0 6px 6px 0;
        }

        .cwm-closing .pull-quote p {
        font-size: 1.15rem;
        font-style: italic;
        color: var(--cwm-text);
        line-height: 1.75;
        margin: 0;
        }

        .cwm-closing .pull-quote .emphasis {
        font-style: normal;
        font-weight: 600;
        color: var(--cwm-accent);
        }

        @media (max-width: 640px) {
        .cwm-closing {
            padding: 3rem 1.25rem;
        }
        .cwm-closing .closing-body {
            font-size: 1rem;
        }
        .cwm-closing .pull-quote {
            padding: 1.25rem 1.5rem;
            margin: 2rem -0.25rem;
        }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>Clinical World Model</h1>
                <span class="nav-subtitle">Clinical Skill-Mix Cube</span>
            </div>
            <div class="nav-links">
                <a href="#framework" class="nav-link active">Framework</a>
                <a href="#overview" class="nav-link">Skill-Mix Cube</a>
                <a href="#competency-explorer" class="nav-link">Competency Explorer</a>
                <a href="#components" class="nav-link">Dimensions Explorer</a>
                <a href="#decision-making" class="nav-link">Decision Making</a>
            </div>
        </div>
    </nav>

    <!-- Framework Overview -->
    <section id="framework" class="framework-section">
        <div class="section-container">
            <div class="framework-content">
                <div class="framework-header">
                    <h2 class="section-title">The Clinical World Model Framework</h2>
                    <p class="section-subtitle">
                        Clinical AI operates within a dynamic triangle of Patient, Provider, and Clinical AI interactions, all occurring within a defined Care Setting.
                    </p>
                </div>

                <div class="framework-diagram">
                    <svg class="triangle-diagram" viewBox="0 0 600 550" xmlns="http://www.w3.org/2000/svg">
                        <!-- Setting Triangle (blue background) -->
                        <defs>
                            <!-- Gradients for nodes with depth -->
                            <radialGradient id="patientGradient" cx="30%" cy="30%">
                                <stop offset="0%" style="stop-color:#ff6b6b;stop-opacity:1"/>
                                <stop offset="100%" style="stop-color:#c92a2a;stop-opacity:1"/>
                            </radialGradient>

                            <radialGradient id="providerGradient" cx="30%" cy="30%">
                                <stop offset="0%" style="stop-color:#8ce99a;stop-opacity:1"/>
                                <stop offset="100%" style="stop-color:#37b24d;stop-opacity:1"/>
                            </radialGradient>

                            <radialGradient id="aiGradient" cx="30%" cy="30%">
                                <stop offset="0%" style="stop-color:#ffe066;stop-opacity:1"/>
                                <stop offset="100%" style="stop-color:#fab005;stop-opacity:1"/>
                            </radialGradient>

                            <!-- Glow filters for nodes -->
                            <filter id="patientGlow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>

                            <filter id="providerGlow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>

                            <filter id="aiGlow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="5" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>

                            <!-- Drop shadow for nodes -->
                            <filter id="dropShadow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                                <feOffset dx="0" dy="3" result="offsetblur"/>
                                <feComponentTransfer>
                                    <feFuncA type="linear" slope="0.3"/>
                                </feComponentTransfer>
                                <feMerge>
                                    <feMergeNode/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>

                            <!-- Animated gradient for connection flows -->
                            <linearGradient id="flowGradient1">
                                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0">
                                    <animate attributeName="offset" values="-0.5;1.5" dur="2.5s" repeatCount="indefinite"/>
                                </stop>
                                <stop offset="25%" style="stop-color:#ffffff;stop-opacity:1">
                                    <animate attributeName="offset" values="-0.25;1.75" dur="2.5s" repeatCount="indefinite"/>
                                </stop>
                                <stop offset="50%" style="stop-color:#ffffff;stop-opacity:0">
                                    <animate attributeName="offset" values="0;2" dur="2.5s" repeatCount="indefinite"/>
                                </stop>
                            </linearGradient>

                            <linearGradient id="flowGradient2">
                                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0">
                                    <animate attributeName="offset" values="-0.5;1.5" dur="3s" repeatCount="indefinite"/>
                                </stop>
                                <stop offset="25%" style="stop-color:#ffffff;stop-opacity:1">
                                    <animate attributeName="offset" values="-0.25;1.75" dur="3s" repeatCount="indefinite"/>
                                </stop>
                                <stop offset="50%" style="stop-color:#ffffff;stop-opacity:0">
                                    <animate attributeName="offset" values="0;2" dur="3s" repeatCount="indefinite"/>
                                </stop>
                            </linearGradient>

                            <linearGradient id="flowGradient3">
                                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0">
                                    <animate attributeName="offset" values="-0.5;1.5" dur="2.8s" repeatCount="indefinite"/>
                                </stop>
                                <stop offset="25%" style="stop-color:#ffffff;stop-opacity:1">
                                    <animate attributeName="offset" values="-0.25;1.75" dur="2.8s" repeatCount="indefinite"/>
                                </stop>
                                <stop offset="50%" style="stop-color:#ffffff;stop-opacity:0">
                                    <animate attributeName="offset" values="0;2" dur="2.8s" repeatCount="indefinite"/>
                                </stop>
                            </linearGradient>
                        </defs>

                        <!-- Blue Triangle (Setting) - Updated for inverted triangle -->
                        // WITH THIS:
                        <path d="M 30 30 L 570 30 L 300 600 Z"
                            fill="rgba(131, 229, 255, 0.12)"
                            stroke="none"
                            opacity="0.8">
                        </path>

                        <!-- Setting Label -->
                        <text x="300" y="250" text-anchor="middle" fill="#4dabf7" font-size="20" font-weight="600" opacity="0.6" letter-spacing="2">
                            Care Setting
                        </text>

                        <!-- Connection lines with gradient flow animations -->

                        <!-- Patient <-> Provider (Top horizontal) -->
                        <path d="M 180 100 L 420 100"
                              stroke="rgba(131, 229, 255, 0.4)"
                              stroke-width="3"
                              fill="none"
                              stroke-linecap="round"/>
                        <path d="M 180 100 L 420 100"
                              stroke="url(#flowGradient1)"
                              stroke-width="3"
                              fill="none"
                              stroke-linecap="round"/>

                        <!-- Patient <-> Clinical AI (Left diagonal) -->
                        <path d="M 175 130 L 275 440"
                              stroke="rgba(255, 235, 102, 0.4)"
                              stroke-width="3"
                              fill="none"
                              stroke-linecap="round"/>
                        <path d="M 175 130 L 275 440"
                              stroke="url(#flowGradient2)"
                              stroke-width="3"
                              fill="none"
                              stroke-linecap="round"/>

                        <!-- Provider <-> Clinical AI (Right diagonal) -->
                        <path d="M 425 130 L 325 440"
                              stroke="rgba(114, 213, 154, 0.4)"
                              stroke-width="3"
                              fill="none"
                              stroke-linecap="round"/>
                        <path d="M 425 130 L 325 440"
                              stroke="url(#flowGradient3)"
                              stroke-width="3"
                              fill="none"
                              stroke-linecap="round"/>

                        <!-- Patient Node (Red - Top Left) -->
                        <g filter="url(#dropShadow)">
                            <circle cx="150" cy="100" r="50" fill="url(#patientGradient)" filter="url(#patientGlow)" stroke="#fff" stroke-width="4" opacity="0.95">
                                <animate attributeName="r" values="50;53;50" dur="4s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="150" cy="100" r="42" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
                            <text x="150" y="108" text-anchor="middle" fill="#fff" font-size="18" font-weight="700" letter-spacing="0.5">Patient</text>
                        </g>

                        <!-- Provider Node (Green - Top Right) -->
                        <g filter="url(#dropShadow)">
                            <circle cx="450" cy="100" r="50" fill="url(#providerGradient)" filter="url(#providerGlow)" stroke="#fff" stroke-width="4" opacity="0.95">
                                <animate attributeName="r" values="50;53;50" dur="4s" begin="1.3s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="450" cy="100" r="42" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1.5"/>
                            <text x="450" y="108" text-anchor="middle" fill="#fff" font-size="18" font-weight="700" letter-spacing="0.5">Provider</text>
                        </g>

                        <!-- Clinical AI Node (Yellow - Bottom Center) -->
                        <g filter="url(#dropShadow)">
                            <circle cx="300" cy="470" r="55" fill="url(#aiGradient)" filter="url(#aiGlow)" stroke="#fff" stroke-width="4" opacity="0.95">
                                <animate attributeName="r" values="55;59;55" dur="4s" begin="2.6s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="300" cy="470" r="47" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="1.5"/>

                            <!-- AI Icon/Symbol -->
                            <circle cx="300" cy="460" r="3" fill="#333" opacity="0.7"/>
                            <circle cx="308" cy="464" r="2.5" fill="#333" opacity="0.7"/>
                            <circle cx="292" cy="464" r="2.5" fill="#333" opacity="0.7"/>
                            <path d="M 292 473 Q 300 478 308 473" stroke="#333" stroke-width="2" fill="none" opacity="0.7" stroke-linecap="round"/>

                            <text x="300" y="493" text-anchor="middle" fill="#333" font-size="17" font-weight="700" letter-spacing="0.5">Clinical AI</text>
                        </g>

                        <!-- Animated signal dots on connections -->

                        <!-- Patient -> Provider signal -->
                        <circle r="5" fill="#e34f53" opacity="0.9">
                            <animateMotion dur="3s" repeatCount="indefinite">
                                <mpath href="#path1"/>
                            </animateMotion>
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="3s" repeatCount="indefinite"/>
                        </circle>
                        <path id="path1" d="M 180 100 L 420 100" fill="none"/>

                        <!-- Patient -> AI signal -->
                        <circle r="5" fill="#ff6b6b" opacity="0.9">
                            <animateMotion dur="3.5s" repeatCount="indefinite">
                                <mpath href="#path2"/>
                            </animateMotion>
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="3.5s" repeatCount="indefinite"/>
                        </circle>
                        <path id="path2" d="M 175 130 L 275 440" fill="none"/>

                        <!-- Provider -> AI signal -->
                        <circle r="5" fill="#72d59a" opacity="0.9">
                            <animateMotion dur="3.2s" repeatCount="indefinite">
                                <mpath href="#path3"/>
                            </animateMotion>
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="3.2s" repeatCount="indefinite"/>
                        </circle>
                        <path id="path3" d="M 425 130 L 325 440" fill="none"/>

                        <!-- AI -> Patient signal (reverse flow) -->
                        <circle r="5" fill="#ffe066" opacity="0.8">
                            <animateMotion dur="3.5s" begin="1.75s" repeatCount="indefinite">
                                <mpath href="#path4"/>
                            </animateMotion>
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="3.5s" begin="1.75s" repeatCount="indefinite"/>
                        </circle>
                        <path id="path4" d="M 275 440 L 175 130" fill="none"/>

                        <!-- AI -> Provider signal (reverse flow) -->
                        <circle r="5" fill="#ffe066" opacity="0.8">
                            <animateMotion dur="3.2s" begin="1.6s" repeatCount="indefinite">
                                <mpath href="#path5"/>
                            </animateMotion>
                            <animate attributeName="opacity" values="0.3;1;0.3" dur="3.2s" begin="1.6s" repeatCount="indefinite"/>
                        </circle>
                        <path id="path5" d="M 325 440 L 425 130" fill="none"/>

                    </svg>

                    <div class="triangle-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #ff6b6b, #c92a2a);"></div>
                            <span><strong>Patient:</strong> Healthcare recipient with unique needs, preferences, and clinical context</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #8ce99a, #37b24d);"></div>
                            <span><strong>Provider:</strong> Healthcare professional delivering care</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #ffe066, #fab005);"></div>
                            <span><strong>Clinical AI:</strong> Intelligent system augmenting and/or automating decision making</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(131, 229, 255, 0.4); border: 2px dashed #4dabf7;"></div>
                            <span><strong>Care Setting:</strong> Healthcare environment providing context for all interactions</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Clinical World Model Section -->
    <section id="overview" class="hero">
        <div class="hero-container">
            <div class="hero-content">
                <h1 class="hero-title">Clinical Skill-Mix<br><span class="hero-subtitle-inline">8-Dimensions (5C + 3A) to Bound Competency Cell</span></h1>
                <p class="hero-subtitle">
                    Two interconnected spaces clash to define the Clinical AI Skill-Mix: What is the Clinical Competency (5C) and how AI Engagement (3A) happens within it?
                </p>
                <div class="hero-stats-grid">
                    <div class="stats-group">
                        <h3 class="stats-group-title">Clinical Competency (5C)</h3>
                        <div class="stat-item stat-condition">
                            <span class="stat-number">1,918</span>
                            <span class="stat-label">Condition</span>
                        </div>
                        <div class="stat-item stat-care-phase">
                            <span class="stat-number">7</span>
                            <span class="stat-label">Care Phase</span>
                        </div>
                        <div class="stat-item stat-care-setting">
                            <span class="stat-number">12</span>
                            <span class="stat-label">Care Setting</span>
                        </div>
                        <div class="stat-item stat-care-task">
                            <span class="stat-number">58</span>
                            <span class="stat-label">Care Task</span>
                        </div>
                        <div class="stat-item stat-care-provider">
                            <span class="stat-number">86</span>
                            <span class="stat-label">Provider Role<br>(36 Physician)</span>
                        </div>
                    </div>
                    <div class="stats-group">
                        <h3 class="stats-group-title">AI Engagement (3A)</h3>
                        <div class="stat-item stat-agent-facing">
                            <span class="stat-number">3</span>
                            <span class="stat-label">Agent Facing</span>
                        </div>
                        <div class="stat-item stat-anchoring-layer">
                            <span class="stat-number">7</span>
                            <span class="stat-label">Anchoring Layer</span>
                        </div>
                        <div class="stat-item stat-assigned-authority">
                            <span class="stat-number">3</span>
                            <span class="stat-label">Assigned Authority</span>
                        </div>
                    </div>
                </div>
                <div class="hero-total">
                    <p class="total-label">Total Cells (5C √ó 3A) within Skill-Mix Cube:</p>
                    <p class="total-number">50,628,479,328</p>
                    <p class="total-breakdown">9.3M clinical scenarios per provider √ó 63 AI engagement patterns</p>
                    <p class="total-breakdown">= 588.7M clinical AI scenarios per provider</p>
                </div>
                <div class="hero-actions">
                    <button class="btn btn-primary" onclick="scrollToSection('competency-explorer')">
                        <i data-lucide="box"></i>
                        Explore Intelligence Cells
                    </button>
                    <button class="btn btn-secondary" onclick="scrollToSection('components')">
                        <i data-lucide="layers"></i>
                        View All Dimensions
                    </button>
                </div>
            </div>
            <div class="hero-visual">
                <div class="dual-cubes">
                    <div class="cube-wrapper">
                        <div class="cube-label">5C</div>
                        <div class="dimension-cube cube-5c">
                            <div class="cube-face front" style="background: var(--color-care-task);">Care Task</div>
                            <div class="cube-face back" style="background: var(--color-care-setting);">Care Setting</div>
                            <div class="cube-face right" style="background: var(--color-care-provider-role);">Provider</div>
                            <div class="cube-face left" style="background: var(--color-care-phase);">Phase</div>
                            <div class="cube-face top" style="background: var(--color-condition);">Condition</div>
                            <div class="cube-face bottom" style="background: var(--gray-300);">5C</div>
                        </div>
                    </div>
                    <div class="cube-wrapper">
                        <div class="cube-label">3A</div>
                        <div class="dimension-cube cube-3a">
                            <div class="cube-face front" style="background: var(--color-agent-facing); color: #333;">Agent Facing</div>
                            <div class="cube-face back" style="background: var(--color-agent-facing); color: #333;">Agent Facing</div>
                            <div class="cube-face right" style="background: var(--color-assigned-authority); color: #333;">Assigned Authority</div>
                            <div class="cube-face left" style="background: var(--color-assigned-authority); color: #333;">Assigned Authority</div>
                            <div class="cube-face top" style="background: var(--color-anchoring-layer); color: #333;">Anchoring Layer</div>
                            <div class="cube-face bottom" style="background: var(--color-anchoring-layer); color: #333;">Anchoring Layer</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Clinical Competency Explorer -->
    <section id="competency-explorer" class="competency-explorer-section">
        <div class="section-container">
            <div class="section-header">
                <!-- Combined Clinical Intelligence Output -->
                <div class="clinical-intelligence-output">
                    <h2 class="section-title">Explore a Cell ‚Äî Clinical AI Competency</h2>
                    <div id="combined-scenario" class="scenario-text">
                        Select dimensions from both cubes below to generate a complete Clinical Intelligence specification...
                    </div>
                    
                    <div>
                        <blockquote class="framework-quote">
                            <p>Each Clinical Intelligence Cell (5C √ó 3A) represents a unique capability requiring distinct evaluation approaches, defined by:</p>
                            <ul>
                                <li><strong>Clinical Competency Scenario</strong> ‚Äî condition, care phase, setting, task, provider role</li>
                                <li><strong>AI Engagement</strong> ‚Äî agent facing, anchoring layer, assigned authority</li>
                                <li><strong>Performance Metrics</strong> ‚Äî accuracy, clinical safety, reliability, clinical utility, and skill preservation safety</li>
                            </ul>
                        </blockquote>
                    </div>
                </div>
            </div>




            <!-- Two-column grid for cube selectors -->
            <div class="cubes-grid">
                <!-- Clinical Competency Cube (5C) -->
                <div class="cube-container" id="clinical-competency-cube">
                <h3 class="cube-title">Clinical Competency (5C)</h3>
                <p class="cube-description">Five dimensions defining WHAT clinical scenario</p>

                <div class="cube-selector-grid">
                    <div class="dimension-selector-item" data-dimension="condition">
                        <label class="selector-label">
                            <span class="label-icon">üè•</span>
                            <span class="label-text">Condition</span>
                        </label>
                        <select id="condition-select" class="dimension-select">
                            <option value="">Select a condition...</option>
                        </select>
                    </div>

                    <div class="dimension-selector-item" data-dimension="care-phase">
                        <label class="selector-label">
                            <span class="label-icon">‚è±Ô∏è</span>
                            <span class="label-text">Care Phase</span>
                        </label>
                        <select id="care-phase-select" class="dimension-select">
                            <option value="">Select a care phase...</option>
                        </select>
                    </div>

                    <div class="dimension-selector-item" data-dimension="care-setting">
                        <label class="selector-label">
                            <span class="label-icon">üìç</span>
                            <span class="label-text">Care Setting</span>
                        </label>
                        <select id="care-setting-select" class="dimension-select">
                            <option value="">Select a care setting...</option>
                        </select>
                    </div>

                    <div class="dimension-selector-item" data-dimension="care-task">
                        <label class="selector-label">
                            <span class="label-icon">üéØ</span>
                            <span class="label-text">Care Task</span>
                        </label>
                        <select id="care-task-select" class="dimension-select">
                            <option value="">Select a care task...</option>
                        </select>
                    </div>

                    <div class="dimension-selector-item" data-dimension="care-provider-role">
                        <label class="selector-label">
                            <span class="label-icon">üë§</span>
                            <span class="label-text">Care Provider Role</span>
                        </label>
                        <select id="care-provider-role-select" class="dimension-select">
                            <option value="">Select a provider role...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- AI Engagement Cube (3A) -->
            <div class="cube-container" id="ai-cognitive-cube">
                <h3 class="cube-title">AI Engagement (3A)</h3>
                <p class="cube-description">Three dimensions defining HOW AI engages</p>

                <div class="cube-selector-grid">
                    <div class="dimension-selector-item" data-dimension="agent-facing">
                        <label class="selector-label">
                            <span class="label-icon">üë•</span>
                            <span class="label-text">Agent Facing</span>
                        </label>
                        <select id="agent-facing-select" class="dimension-select">
                            <option value="">Select agent facing...</option>
                        </select>
                    </div>

                    <div class="dimension-selector-item" data-dimension="anchoring-layer">
                        <label class="selector-label">
                            <span class="label-icon">üß†</span>
                            <span class="label-text">Anchoring Layer</span>
                        </label>
                        <select id="anchoring-layer-select" class="dimension-select">
                            <option value="">Select anchoring layer...</option>
                        </select>
                    </div>

                    <div class="dimension-selector-item" data-dimension="assigned-authority">
                        <label class="selector-label">
                            <span class="label-icon">‚ö°</span>
                            <span class="label-text">Assigned Authority</span>
                        </label>
                        <select id="assigned-authority-select" class="dimension-select">
                            <option value="">Select assigned authority...</option>
                        </select>
                    </div>
                </div>
            </div>
            </div><!-- End cubes-grid -->

        </div>
    </section>

    <!-- Cube Dimensions -->
    <section id="components" class="explorer-section">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">8 Dimensions Explorer</h2>
                <p class="section-subtitle">
                    Each dimension represents a constituent element defining bounderies of clinical scenarios and AI engagement patterns.
                </p>
            </div>

            <div class="explorer-container">
                <!-- Dimension Selector -->
                <div class="explorer-sidebar">
                    <div class="dimension-selector">
                        <h3>Select Dimension</h3>
                        <div class="selector-buttons">
                            <button class="selector-btn active" data-dimension="care_task">
                                <i data-lucide="stethoscope"></i>
                                <span>Care Tasks</span>
                            </button>
                            <button class="selector-btn" data-dimension="care_provider_role">
                                <i data-lucide="users"></i>
                                <span>Provider Roles</span>
                            </button>
                            <button class="selector-btn" data-dimension="condition">
                                <i data-lucide="activity"></i>
                                <span>Conditions</span>
                            </button>
                            <button class="selector-btn" data-dimension="care_phase">
                                <i data-lucide="git-branch"></i>
                                <span>Care Phases</span>
                            </button>
                            <button class="selector-btn" data-dimension="care_setting">
                                <i data-lucide="map-pin"></i>
                                <span>Care Settings</span>
                            </button>
                            <button class="selector-btn" data-dimension="agent_facing">
                                <i data-lucide="user-check"></i>
                                <span>Agent Facing</span>
                            </button>
                            <button class="selector-btn" data-dimension="anchoring_layer">
                                <i data-lucide="layers"></i>
                                <span>Anchoring Layer</span>
                            </button>
                            <button class="selector-btn" data-dimension="assigned_authority">
                                <i data-lucide="shield"></i>
                                <span>Assigned Authority</span>
                            </button>
                        </div>
                    </div>

                    <div class="explorer-controls">
                        <h3>View Options</h3>
                        <div class="control-group">
                            <label class="control-label">
                                <input type="radio" name="view-mode" value="hierarchy" checked>
                                <span>Hierarchical View</span>
                            </label>
                            <label class="control-label">
                                <input type="radio" name="view-mode" value="list">
                                <span>List View</span>
                            </label>
                        </div>

                        <div class="control-group">
                            <label class="control-label">
                                <input type="checkbox" id="show-metadata" checked>
                                <span>Show Metadata</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Main Visualization Area -->
                <div class="explorer-main">
                    <div class="explorer-header">
                        <h3 id="current-dimension-title">Care Tasks</h3>
                        <div class="explorer-actions">
                            <button class="btn btn-sm" onclick="exportDimension()">
                                <i data-lucide="download"></i>
                                Export
                            </button>
                            <button class="btn btn-sm" onclick="fullscreenVisualization()">
                                <i data-lucide="maximize"></i>
                                Fullscreen
                            </button>
                        </div>
                    </div>
                    
                    <div class="visualization-container">
                        <div id="dimension-visualization" class="visualization-content">
                            <!-- Dynamic content will be loaded here -->
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Loading dimension data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Decision Making Section -->
    <section id="decision-making" class="decision-making-section">
        <div class="section-container">
            <header class="section-header animate-in">
                <div class="section-badge">
                    <i data-lucide="brain"></i>
                    <span>Cognitive Framework</span>
                </div>
                <h2 class="section-title">
                    <span class="gradient-text">Decision Making</span> in Clinical Practice
                </h2>
                <p class="section-subtitle">
                    A philosophical exploration of <strong>medical cognition</strong>‚Äîmapping how clinicians and patients
                    process information through iterative cycles of <strong>intuition</strong>, <strong>analysis</strong>,
                    and <strong>reflection</strong>. The hypothesis serves as the central organizing concept, mediating
                    between three cognitive processor engines in a dynamic, bidirectional exchange.
                </p>
            </header>

            <div class="control-panel animate-in delay-100">
                <button class="control-btn active" id="playBtn"><i data-lucide="play"></i><span>Simulate</span></button>
                <button class="control-btn" id="pauseBtn"><i data-lucide="pause"></i><span>Pause</span></button>
                <button class="control-btn" id="resetBtn"><i data-lucide="rotate-ccw"></i><span>Reset</span></button>
                <div class="speed-control">
                    <label>Speed:</label>
                    <input type="range" id="speedSlider" min="0.5" max="2.5" step="0.25" value="1">
                </div>
                <button class="control-btn" id="syncBtn"><i data-lucide="link"></i><span>Sync</span></button>
            </div>

            <div class="visualization-grid animate-in delay-200">
                <div class="decision-card cdm-card" id="cdmCard">
                    <div class="card-header cdm-header">
                        <div class="card-title-row">
                            <div class="card-icon"><i data-lucide="stethoscope"></i></div>
                            <h3 class="card-title">Clinician Decision Making</h3>
                        </div>
                        <p class="card-description">The physician's cognitive architecture: integrating clinical data, knowledge, and experience through dual-process reasoning.</p>
                    </div>
                    <div class="card-body">
                        <div class="flow-canvas" id="cdmCanvas">
                            <div class="status-bar">
                                <div class="loop-counter">
                                    <span>Iteration:</span>
                                    <div class="loop-dots" id="cdmLoopDots">
                                        <div class="loop-dot active"></div>
                                        <div class="loop-dot"></div>
                                        <div class="loop-dot"></div>
                                        <div class="loop-dot"></div>
                                    </div>
                                </div>
                                <div class="current-stage">
                                    <div class="stage-dot"></div>
                                    <span id="cdmStageText">Awaiting Input</span>
                                </div>
                            </div>
                            <svg class="flow-svg" id="cdmSvg" viewBox="0 0 520 880"></svg>
                        </div>
                    </div>
                </div>

                <div class="center-connector">
                    <span class="connector-label">Shared</span>
                    <div class="connector-line"></div>
                    <div class="interaction-hub" id="interactionHub">
                        <div class="hub-icon-wrapper"><i data-lucide="repeat"></i></div>
                        <span class="hub-label">Clinical</span>
                        <span class="hub-sublabel">Encounter</span>
                    </div>
                    <div class="connector-line"></div>
                    <span class="connector-label">Decision</span>
                </div>

                <div class="decision-card pdm-card" id="pdmCard">
                    <div class="card-header pdm-header">
                        <div class="card-title-row">
                            <div class="card-icon"><i data-lucide="user"></i></div>
                            <h3 class="card-title">Patient Decision Making</h3>
                        </div>
                        <p class="card-description">The patient's cognitive journey: processing clinical information through values, context, and lived experience.</p>
                    </div>
                    <div class="card-body">
                        <div class="flow-canvas" id="pdmCanvas">
                            <div class="status-bar">
                                <div class="loop-counter">
                                    <span>Iteration:</span>
                                    <div class="loop-dots" id="pdmLoopDots">
                                        <div class="loop-dot active"></div>
                                        <div class="loop-dot"></div>
                                        <div class="loop-dot"></div>
                                        <div class="loop-dot"></div>
                                    </div>
                                </div>
                                <div class="current-stage">
                                    <div class="stage-dot"></div>
                                    <span id="pdmStageText">Awaiting Input</span>
                                </div>
                            </div>
                            <svg class="flow-svg" id="pdmSvg" viewBox="0 0 520 880"></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Philosophy Foundation - Full Width -->
            <div class="info-panels-philosophy animate-in delay-300">
                <div class="info-panel info-panel-full">
                    <div class="panel-header">
                        <div class="panel-icon philosophy"><i data-lucide="sparkles"></i></div>
                        <h4 class="panel-title">Philosophical Foundation</h4>
                    </div>
                    <blockquote class="philosophy-quote">
                        "Clinical reasoning is not merely the application of medical knowledge, but an iterative dialogue between intuitive pattern recognition and deliberate analytical thinking‚Äîa cognitive dance where the hypothesis serves as both guide and test of our understanding."
                        <cite>‚Äî Clinical World Model Framework</cite>
                    </blockquote>
                </div>
            </div>

            <!-- Legend and Process Flow - 1/3 and 2/3 -->
            <div class="info-panels-split animate-in delay-300">
                <div class="info-panel info-panel-third">
                    <div class="panel-header">
                        <div class="panel-icon legend"><i data-lucide="palette"></i></div>
                        <h4 class="panel-title">Visual Legend</h4>
                    </div>
                    <div class="legend-grid" id="legendGrid"></div>
                </div>
                <div class="info-panel info-panel-twothirds">
                    <div class="panel-header">
                        <div class="panel-icon process"><i data-lucide="git-branch"></i></div>
                        <h4 class="panel-title">Cognitive Process Flow</h4>
                    </div>
                    <div class="process-steps">
                        <div class="process-step">
                            <div class="step-num">1</div>
                            <div class="step-content">
                                <h4>Input Integration</h4>
                                <p>Clinical data, context, and prior knowledge converge at the processor</p>
                            </div>
                        </div>
                        <div class="process-step">
                            <div class="step-num">2</div>
                            <div class="step-content">
                                <h4>Hypothesis Formation</h4>
                                <p>Central concept emerges, mediating three processor engines (2-4 iterations)</p>
                            </div>
                        </div>
                        <div class="process-step">
                            <div class="step-num">3</div>
                            <div class="step-content">
                                <h4>Dual-System Processing</h4>
                                <p>System I (intuition) and System II (analysis) evaluate in bidirectional reflection</p>
                            </div>
                        </div>
                        <div class="process-step">
                            <div class="step-num">4</div>
                            <div class="step-content">
                                <h4>Action Resolution</h4>
                                <p>Proceed to planning/preference or loop back via data collection</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="dm-tooltip" id="dmTooltip">
        <div class="dm-tooltip-header"></div>
        <ul class="dm-tooltip-list"></ul>
    </div>

    <!-- Footer -->
<footer class="footer">
        <div class="footer-container">
            <!-- About and Resources Section -->
            <div class="footer-about-resources">
                <div class="footer-about">
                    <h4>About the Clinical World Model</h4>
                    <p>
                        <strong class="about-lead">We began with an observation that has become difficult to ignore:</strong>
                        clinical AI systems that excel on benchmarks routinely falter at the bedside, and existing frameworks, while each contributing essential foundations, lack the cognitive grounding to explain why. Rather than proposing yet another evaluation checklist, we chose to look backward, drawing on decades of empirically validated work in clinical reasoning, dual-process cognition, and medical education to build forward.
                    </p>
                    <p>
                        The <strong>Clinical World Model</strong> formalizes clinical care as it actually unfolds, through iterative interactions among Patient, Provider, and Ecosystem, with parallel decision-making architectures rooted in how clinicians and patients genuinely think.
                        The <strong>Clinical AI Skill-Mix</strong> then operationalizes this architecture through an eight-dimensional structure
                        (<span class="dim-highlight">5C+3A</span>), where five Clinical Competency dimensions
                        (<span class="dim-highlight">Condition</span>, <span class="dim-highlight">Care Phase</span>, <span class="dim-highlight">Care Setting</span>, <span class="dim-highlight">Care Task</span>, <span class="dim-highlight">Care Provider Role</span>)
                        intersect with three AI Cognitive Engagement dimensions
                        (<span class="dim-highlight">Agent Facing</span>, <span class="dim-highlight">Anchoring Layer</span>, <span class="dim-highlight">Assigned Authority</span>)
                        to yield a combinatorial competency space exceeding 50 billion unique cells, each representing a distinct configuration where validation in one provides minimal evidence for another.
                    </p>
                    <p>
                        We do not claim theoretical completeness, and empirical validation through prospective application remains necessary.
                    </p>
                    <blockquote class="about-pullquote">
                        The field has long asked whether clinical AI works. We believe the more constructive question is
                        <em class="pullquote-emphasis">in which competency coordinates</em> a system has demonstrated reliability, and <em class="pullquote-emphasis">for whom</em>.
                    </blockquote>
                </div>
                <div class="footer-resources">
                    <h4>Resources</h4>
                    <div class="footer-resource-links">
                        <a href="https://github.com/sdamirsa/Clinical-World-Model" class="footer-resource-link">
                            <i data-lucide="github"></i>
                            <span>GitHub Repository</span>
                        </a>
                        <a href="clinical-skill-mix/" class="footer-resource-link">
                            <i data-lucide="database"></i>
                            <span>Raw Data Files</span>
                        </a>
                    </div>
                </div>
            </div>

            <div class="footer-citation">
                <div class="footer-citation-header">
                    <h4>Cite this Paper</h4>
                    <button class="bibtex-copy-btn" onclick="copyBibtex()" title="Copy BibTeX to clipboard">
                        <i data-lucide="clipboard-copy"></i>
                        <span class="bibtex-btn-label">Copy BibTeX</span>
                    </button>
                </div>
                <div class="footer-citation-content">
                    <p class="citation-title">
                        <strong>Grounding Clinical AI Competency in Human Cognition Through the Clinical World Model and Skill-Mix Framework</strong>
                    </p>
                    <p class="citation-authors">
                        Seyed Amir Ahmad Safavi-Naini, Elahe Meftah, Josh Mohess, Pooya Mohammadi Kazaj, Georgios Siontis, Zahra Atf, Peter R. Lewis, Girish Nadkarni, Stephan Windecker, Christoph Gr√§ni, Ali Soroush, Isaac Shiri
                    </p>
                    <p class="citation-correspondence">
                        Correspondence: Seyed Amir Ahmad Safavi-Naini (<a href="mailto:sdamirsa@ymail.com">sdamirsa@ymail.com</a>)
                    </p>
                </div>
            </div>

            <div class="footer-affiliations">
                <h4>Affiliations</h4>
                <div class="footer-affiliation-list">
                    <p>Department of Digital Medicine, Bern University Hospital, University of Bern, Bern, Switzerland</p>
                    <p>Division of Data-Driven and Digital Medicine (D3M), Icahn School of Medicine at Mount Sinai, New York, United States</p>
                </div>
                <div class="footer-logos">
                    <a href="https://ai-cvm.org" target="_blank" rel="noopener noreferrer">
                        <img src="assets/logo/AI-CVM-Wide-White.webp" alt="AI-CVM" class="footer-logo">
                    </a>
                    <a href="https://aisinai.org" target="_blank" rel="noopener noreferrer">
                        <img src="assets/logo/SINAI-color-white-smalled.png" alt="Mount Sinai" class="footer-logo">
                    </a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Clinical World Model. Licensed under MIT License.</p>
            </div>
        </div>
    </footer>

    <!-- BibTeX hidden element and copy script -->
<template id="bibtex-data">
@unpublished{safavi-naini2025clinicalworldmodel,
  title     = {Grounding Clinical AI Competency in Human Cognition Through the Clinical World Model and Skill-Mix Framework},
  author    = {Safavi-Naini, Seyed Amir Ahmad and Meftah, Elahe and Mohess, Josh and Mohammadi Kazaj, Pooya and Siontis, Georgios and Atf, Zahra and Lewis, Peter R. and Nadkarni, Girish and Windecker, Stephan and Gr{\"a}ni, Christoph and Soroush, Ali and Shiri, Isaac},
  year      = {2025},
  note      = {Manuscript submitted for publication}
}
</template>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.263.1/dist/umd/lucide.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/dimension-loader.js"></script>
    <script src="assets/js/visualization.js"></script>

    <!-- Decision Making Visualization Script -->
    <script>
        // ============================================
        // COMPLETE DATA STRUCTURES FROM FIGURES
        // ============================================

        const CDM_DATA = {
            id: "cdm",
            title: "Clinician Decision Making",
            colors: {
                primary: "#c026d3",
                secondary: "#a855f7",
                tertiary: "#7c3aed",
                light: "#fae8ff",
                input: "#db2777",
                processor: "#7c3aed",
                hypothesis: "#d1d5db",
                system1: "#3b82f6",
                system2: "#6366f1",
                planning: "#3b82f6",
                collection: "#3b82f6"
            },
            inputs: {
                main: { id: "input", label: "Input", color: "#db2777", description: ["Clinical data from multiple sources", "Encounter context", "Patient information", "Medical records"] },
                categories: [
                    {
                        id: "encounter",
                        label: "Encounter",
                        color: "#f9a8d4",
                        items: [
                            "Physical interaction",
                            "Clinician sense/flow",
                            "Verbal communication"
                        ]
                    },
                    {
                        id: "encounter_context",
                        label: "Encounter context",
                        color: "#f9a8d4",
                        items: [
                            "Resources (dynamics, equipment, time)",
                            "Routines (legal authority & guidelines)"
                        ]
                    },
                    {
                        id: "patient_context",
                        label: "Patient context",
                        color: "#f9a8d4",
                        items: [
                            "Preference",
                            "Support and constrain"
                        ]
                    },
                    {
                        id: "records",
                        label: "Records",
                        sublabel: "(Ecosystem)",
                        color: "#f9a8d4",
                        items: [
                            "Notes",
                            "Imaging",
                            "Therapeutics",
                            "Pathology & Labs",
                            "Procedures"
                        ]
                    }
                ]
            },
            processor: {
                id: "data_processor",
                label: "Data processor",
                color: "#7c3aed",
                description: ["Evidence-guided synthesis", "Transforms raw inputs into clinically meaningful cues"]
            },
            hypothesis: {
                id: "hypothesis",
                label: "Hypothesis",
                color: "#d1d5db",
                textColor: "#1f2937",
                description: ["Central organizing concept", "Mediates between data processing and reasoning", "Refined through dual-system cycles", "Evaluated via reflection"]
            },
            systems: {
                system2: {
                    id: "system2",
                    label: "System II:",
                    sub: "Analytical",
                    color: "#6366f1",
                    position: "left",
                    description: ["Slow, deliberate analytical reasoning", "Hypothetico-deductive analysis", "Evidence-based evaluation", "Conscious, effortful processing"],
                    hexagons: [
                        { id: "hyp_impact", label: "Hypothesis", sub: "impact", description: ["Analyzing hypothesis implications", "Evaluating clinical significance"] },
                        { id: "dec_breakdown", label: "Decision", sub: "breakdown", description: ["Deconstructing decision components", "Systematic analysis"] }
                    ]
                },
                system1: {
                    id: "system1",
                    label: "System I:",
                    sub: "Clinical Intuition",
                    color: "#3b82f6",
                    position: "right",
                    description: ["Fast, automatic pattern recognition", "Illness script activation", "Intuitive judgment", "Subconscious processing"]
                },
                reflection: {
                    id: "reflection",
                    label: "Reflection",
                    color: "#9ca3af",
                    description: ["Metacognitive monitoring", "Self-awareness of reasoning quality", "Bias detection", "Error identification"]
                }
            },
            priors: {
                label: "Priors",
                sublabel: "Bias",
                items: [
                    { id: "official", label: "Official knowledge", sub: "(e.g. book)", description: ["Textbooks", "Medical guidelines", "Evidence-based protocols", "Formal medical education"] },
                    { id: "unofficial", label: "Unofficial knowledge", sub: "(e.g. peer)", description: ["Peer consultation", "Clinical pearls", "Experiential wisdom from colleagues"] },
                    { id: "experience", label: "Clinical &", sub: "encounters experience", description: ["Personal clinical cases", "Patient interactions", "Accumulated practice wisdom"] },
                    { id: "personal", label: "Provider context", sub: "(personality & state)", description: ["Provider's current state", "Personality factors", "Cognitive biases", "Contextual influences"] }
                ],
            },
            outputs: {
                planning: {
                    id: "planning",
                    label: "Finalize planning",
                    color: "#111827",
                    items: ["Diagnosis", "Treatment", "Monitor", "Referral", "Assurance"]
                },
                collection: {
                    id: "collection",
                    label: "Share or request",
                    sublabel: "information",
                    color: "#111827",
                    items: [
                        "Ask and interact with patient",
                        "Share options with patient",
                        "Check system (EHR) and history",
                        "Request an investigation and test",
                        "Ask staff or consult a provider",
                        "Look for knowledge (e.g. guideline)"
                    ]
                }
            },
            action: {
                label: "Action",
                feedback: "New input",
                log: "Log of input, processors, action"
            }
        };

        const PDM_DATA = {
            id: "pdm",
            title: "Patient Decision Making",
            colors: {
                primary: "#0ea5e9",
                secondary: "#06b6d4",
                tertiary: "#0891b2",
                light: "#e0f2fe",
                input: "#db2777",
                processor: "#7c3aed",
                hypothesis: "#d1d5db",
                system1: "#3b82f6",
                system2: "#6366f1",
                finalized: "#111827",
                seeking: "#111827"
            },
            inputs: {
                main: { id: "input", label: "Input", color: "#db2777", description: ["Information from providers", "Life context", "External sources", "Personal experience"] },
                categories: [
                    {
                        id: "encounter",
                        label: "Encounter",
                        color: "#f9a8d4",
                        items: [
                            "Trust & rapport",
                            "Communication skills & barriers",
                            "Diagnosis and disease course",
                            "Debilitation and prognosis",
                            "Available options"
                        ]
                    },
                    {
                        id: "encounter_context",
                        label: "Encounter context",
                        color: "#f9a8d4",
                        items: []
                    },
                    {
                        id: "external_ecosystem",
                        label: "External Ecosystem",
                        color: "#f9a8d4",
                        items: [
                            "Digital sources (e.g. social media)",
                            "Verified / official sources",
                            "Community & peer sources",
                            "Support system",
                            "Resources"
                        ]
                    },
                    {
                        id: "situated_self",
                        label: "Situated self",
                        color: "#f9a8d4",
                        items: [
                            "Constraints & roles", "Support system",
                            "Financial resources",
                        ]
                    },
                    {
                        id: "lived_self",
                        label: "Lived self",
                        color: "#f9a8d4",
                        items: [
                            "Bodily experience",
                            "Emotional state",
                            "Goals & concerns"
                        ]
                    }
                ]
            },
            processor: {
                id: "data_processor",
                label: "Data processor",
                color: "#7c3aed",
                description: ["Processes information through values and lived experience", "Integrates personal context with clinical information"]
            },
            hypothesis: {
                id: "hypothesis",
                label: "Hypothesis",
                color: "#d1d5db",
                textColor: "#1f2937",
                description: ["Central decision concept", "Preference formation", "Refined through dual-system processing", "Evaluated via reflection"]
            },
            systems: {
                system2: {
                    id: "system2",
                    label: "System II:",
                    sub: "Analytical",
                    color: "#6366f1",
                    position: "left",
                    description: ["Deliberate preference analysis", "Weighing options systematically", "Evidence-based evaluation", "Conscious decision-making"],
                    hexagons: [
                        { id: "hyp_impact", label: "Hypothesis", sub: "impact", description: ["Analyzing decision implications", "Evaluating personal impact"] },
                        { id: "dec_breakdown", label: "Decision", sub: "breakdown", description: ["Deconstructing choice components", "Systematic comparison"] }
                    ]
                },
                system1: {
                    id: "system1",
                    label: "System I:",
                    sub: "Clinical Intuition",
                    color: "#3b82f6",
                    position: "right",
                    description: ["Intuitive preference", "Gut feeling about choices", "Fast, automatic processing", "Emotional resonance"]
                },
                reflection: {
                    id: "reflection",
                    label: "Reflection",
                    color: "#9ca3af",
                    description: ["Self-awareness of preference quality", "Bias recognition", "Value alignment check", "Confidence assessment"]
                }
            },
            priors: {
                label: "Priors",
                sublabel: "Bias",
                items: [
                    { id: "embodied", label: "Embodied", sub: "identity", description: ["Personal identity", "Body awareness", "Lived experience"] },
                    { id: "competence", label: "Decision competence", sub: "& autonomy", description: ["Capacity to make healthcare decisions", "Self-determination", "Autonomy in choice"] },
                    { id: "experience", label: "Previous encounter", sub: "experience", description: ["Past medical encounters", "Disease history", "Treatment experiences", "Healthcare interactions"] },
                    { id: "literacy", label: "Health literacy", sub: "", description: ["Understanding medical information", "Navigating healthcare system", "Health knowledge"] }
                ],

            },
            outputs: {
                finalized: {
                    id: "finalized_preference",
                    label: "Communicate",
                    sublabel: "preference",
                    color: "#111827",
                    description: ["Communicating decision to provider", "Expressing preference", "Shared decision-making"],
                    items: []
                },
                seeking: {
                    id: "information_seeking",
                    label: "Share or collect",
                    sublabel: "information",
                    color: "#111827",
                    description: ["Requesting additional information", "Seeking clarification", "Gathering more data"],
                    items: []
                }
            },
            action: {
                label: "Action",
                feedback: "Change in input state",
                log: "Log: IPA state"
            }
        };

        const LEGEND_DATA = [
            { color: "#db2777", label: "Input Hub" },
            { color: "#f9a8d4", label: "Input Categories" },
            { color: "#fce7f3", label: "Input Sub-items" },
            { color: "#7c3aed", label: "Data Processor" },
            { color: "#ede9fe", label: "Processor Knowledge" },
            { color: "#d1d5db", label: "Hypothesis (Central)" },
            { color: "#3b82f6", label: "System I (Intuition)" },
            { color: "#6366f1", label: "System II (Analytical)" },
            { color: "#7c3aed", label: "Reflection" },
            { color: "#3b82f6", label: "Planning (CDM)" },
            { color: "#111827", label: "Preference (PDM)" },
            { color: "#e71a20", label: "Loop Back Path" }
        ];

        // ============================================
        // SVG RENDERER
        // ============================================

        class FlowRenderer {
            constructor(svgElement, data, type) {
                this.svg = svgElement;
                this.data = data;
                this.type = type;
                this.render();
            }

            render() {
                this.svg.innerHTML = '';
                this.createDefs();
                this.drawIPALabel();
                this.drawConnections();
                this.drawRefinementLoop();
                this.drawInputLayer();
                this.drawProcessor();
                // this.drawHypothesis(); // Removed - now part of processing sphere
                this.drawSystems();
                this.drawOutputs();
                this.drawPriors();
            }

            createDefs() {
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');

                // Use black colors for Plan/Coll in CDM, blue in PDM
                const planColors = this.type === 'cdm' ? ['#111827', '#1f2937'] : ['#3b82f6', '#2563eb'];
                const collColors = this.type === 'cdm' ? ['#1f2937', '#374151'] : ['#3b82f6', '#1d4ed8'];

                const gradients = [
                    { id: `${this.type}Input`, colors: ['#db2777', '#ec4899'] },
                    { id: `${this.type}Proc`, colors: ['#7c3aed', '#8b5cf6'] },
                    { id: `${this.type}Sys1`, colors: ['#3b82f6', '#60a5fa'] },
                    { id: `${this.type}Sys2`, colors: ['#6366f1', '#818cf8'] },
                    { id: `${this.type}Plan`, colors: planColors },
                    { id: `${this.type}Coll`, colors: collColors },
                    { id: `${this.type}Black`, colors: ['#111827', '#1f2937'] }
                ];

                gradients.forEach(g => {
                    defs.innerHTML += `
                        <linearGradient id="${g.id}" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:${g.colors[0]}"/>
                            <stop offset="100%" style="stop-color:${g.colors[1]}"/>
                        </linearGradient>
                    `;
                });

                // Radial gradient for processing sphere (white center to light purple outer)
                defs.innerHTML += `
                    <radialGradient id="${this.type}SphereGradient" cx="50%" cy="50%">
                        <stop offset="0%" style="stop-color:#ffffff"/>
                        <stop offset="50%" style="stop-color:#f3e8ff"/>
                        <stop offset="100%" style="stop-color:#e9d5ff"/>
                    </radialGradient>
                `;

                defs.innerHTML += `
                    <marker id="${this.type}Arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#9ca3af"/>
                    </marker>
                    <marker id="${this.type}ArrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#e71a20"/>
                    </marker>
                    <marker id="${this.type}ArrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
                    </marker>
                `;

                this.svg.appendChild(defs);
            }

            drawIPALabel() {
                const g = this.createGroup('ipa-label');

                // Add "IPA iteration" label at the top left
                const text = this.text(10, 20, 'IPA iteration', 11, '#6b7280', '600', '', 'italic');
                text.style.fontFamily = 'system-ui, -apple-system, sans-serif';
                g.appendChild(text);

                this.svg.appendChild(g);
            }

            drawConnections() {
                const g = this.createGroup('connections-layer');

                // Unidirectional arrow from Input to sphere (Data processor top)
                const paths = [
                    { d: 'M260 148 L260 220', stroke: '#d1d5db', width: 2, id: 'path-input-sphere', marker: `url(#${this.type}Arrow)` },
                    // Elbowed paths from reflection to outputs
                    { d: 'M260 560 L260 680 L137 680 L137 705', stroke: '#d1d5db', width: 2, id: 'path-sphere-planning', marker: `url(#${this.type}Arrow)` },
                    { d: 'M260 560 L260 680 L382 680 L382 705', stroke: '#d1d5db', width: 2, id: 'path-sphere-collection', marker: `url(#${this.type}Arrow)` }
                ];

                paths.forEach(p => {
                    const path = this.createPath(p.d, p.stroke, p.width, p.marker);
                    if (p.id) path.setAttribute('id', p.id);
                    g.appendChild(path);
                });

                // Bidirectional arrows between the four processors (dark purple)
                // Data (260, 280) ‚Üî System I (380, 390)
                g.appendChild(this.createBidirectionalArrow(260, 340, 320, 390, '#7c3aed'));

                // Data (260, 280) ‚Üî System II (140, 390)
                g.appendChild(this.createBidirectionalArrow(260, 340, 200, 390, '#7c3aed'));

                // System I (380, 390) ‚Üî Reflection (260, 500)
                g.appendChild(this.createBidirectionalArrow(320, 390, 260, 440, '#7c3aed'));

                // System II (140, 390) ‚Üî Reflection (260, 500)
                g.appendChild(this.createBidirectionalArrow(200, 390, 260, 440, '#7c3aed'));

                // Collection loop back path - different for CDM and PDM
                if (this.type === 'cdm') {
                    // CDM: Go down first, then left, then up to just below Input
                    g.appendChild(this.createPath('M382 795 L382 820 Q382 840 362 840 L30 840 Q10 840 10 820 L10 160 Q10 150 20 150 L260 150', '#e71a20', 2, `url(#${this.type}ArrowRed)`, true, 'flow-path animated', '4,4', 0.5));
                    g.appendChild(this.text(15, 505, 'Loop Back', 8, '#e71a20', '500', 'rotate(-90 15 505)'));
                } else {
                    // PDM: Also connect to just below Input
                    g.appendChild(this.createPath('M365 760 L365 780 Q365 800 345 800 L30 800 Q10 800 10 780 L10 160 Q10 150 20 150 L260 150', '#e71a20', 2, `url(#${this.type}ArrowRed)`, true, 'flow-path animated', '4,4', 0.5));
                    g.appendChild(this.text(15, 475, 'Loop Back', 8, '#e71a20', '500', 'rotate(-90 15 475)'));
                }

                // Draw the spherical processing region
                this.drawProcessingSphere(g);

                this.svg.appendChild(g);
            }

            drawProcessingSphere(g) {
                // Draw large gradient sphere centered among all processors
                // Center point: midway between Data Processor (260, 260) and Systems (around 515)
                const sphereCenterX = 260;
                const sphereCenterY = 390;  // Centered vertically among processors
                const sphereRadius = 190;   // Large enough to visually cover all processors

                // Draw outer sphere with radial gradient
                const outerSphere = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                outerSphere.setAttribute('cx', sphereCenterX);
                outerSphere.setAttribute('cy', sphereCenterY);
                outerSphere.setAttribute('r', sphereRadius);
                outerSphere.setAttribute('fill', `url(#${this.type}SphereGradient)`);
                outerSphere.setAttribute('stroke', '#c084fc');
                outerSphere.setAttribute('stroke-width', '2');
                outerSphere.setAttribute('stroke-dasharray', '8,5');
                outerSphere.setAttribute('opacity', '0.4');
                g.appendChild(outerSphere);

                // Draw inner sphere at center
                const innerSphereRadius = 45;
                const innerSphere = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                innerSphere.setAttribute('cx', sphereCenterX);
                innerSphere.setAttribute('cy', sphereCenterY);
                innerSphere.setAttribute('r', innerSphereRadius);
                innerSphere.setAttribute('fill', '#ffffff');
                innerSphere.setAttribute('stroke', '#c084fc');
                innerSphere.setAttribute('stroke-width', '2');
                g.appendChild(innerSphere);

                // Add labels inside inner sphere: "Cues", "Hypothesis", "Plan" vertically stacked
                const labelSpacing = 14;
                const labelY = sphereCenterY - labelSpacing;  // Start above center

                g.appendChild(this.text(sphereCenterX, labelY, 'Cues', 10, '#7c3aed', '600'));
                g.appendChild(this.text(sphereCenterX, labelY + labelSpacing, 'Hypothesis', 10, '#7c3aed', '600'));
                g.appendChild(this.text(sphereCenterX, labelY + labelSpacing * 2, 'Plan', 10, '#7c3aed', '600'));
            }

            createBidirectionalArrow(x1, y1, x2, y2, color) {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');

                // Draw connecting line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', '2');
                g.appendChild(line);

                // Calculate midpoint
                const midX = (x1 + x2) / 2;
                const midY = (y1 + y2) / 2;

                // Calculate direction vector
                const dx = x2 - x1;
                const dy = y2 - y1;
                const length = Math.sqrt(dx * dx + dy * dy);
                const ux = dx / length;
                const uy = dy / length;

                // Arrow size
                const arrowSize = 8;
                const offset = 15; // Offset from midpoint for arrows

                // First arrow (pointing from 1 to 2)
                const arrow1X = midX - ux * offset;
                const arrow1Y = midY - uy * offset;
                const arrow1 = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                const perpX = -uy;
                const perpY = ux;
                const a1points = `${arrow1X + ux * arrowSize},${arrow1Y + uy * arrowSize} ${arrow1X - ux * arrowSize/2 + perpX * arrowSize/2},${arrow1Y - uy * arrowSize/2 + perpY * arrowSize/2} ${arrow1X - ux * arrowSize/2 - perpX * arrowSize/2},${arrow1Y - uy * arrowSize/2 - perpY * arrowSize/2}`;
                arrow1.setAttribute('points', a1points);
                arrow1.setAttribute('fill', color);
                g.appendChild(arrow1);

                // Second arrow (pointing from 2 to 1)
                const arrow2X = midX + ux * offset;
                const arrow2Y = midY + uy * offset;
                const arrow2 = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                const a2points = `${arrow2X - ux * arrowSize},${arrow2Y - uy * arrowSize} ${arrow2X + ux * arrowSize/2 + perpX * arrowSize/2},${arrow2Y + uy * arrowSize/2 + perpY * arrowSize/2} ${arrow2X + ux * arrowSize/2 - perpX * arrowSize/2},${arrow2Y + uy * arrowSize/2 - perpY * arrowSize/2}`;
                arrow2.setAttribute('points', a2points);
                arrow2.setAttribute('fill', color);
                g.appendChild(arrow2);

                return g;
            }

            drawInputLayer() {
                const g = this.createGroup('input-layer');

                const inputX = 260;
                const inputY = 110;
                const inputRadius = 38;

                // Categories - Draw lines FIRST (background)
                const catPositions = this.type === 'cdm'
                    ? [{ x: 95, y: 95 }, { x: 165, y: 50 }, { x: 355, y: 50 }, { x: 425, y: 95 }]
                    : [{ x: 260, y: 42 }, { x: 110, y: 85 }, { x: 410, y: 85 }, { x: 150, y: 150 }, { x: 370, y: 150 }];

                this.data.inputs.categories.forEach((cat, i) => {
                    if (i >= catPositions.length) return;
                    const pos = catPositions[i];

                    // Calculate connection point on Input circle circumference
                    const angle = Math.atan2(inputY - pos.y, inputX - pos.x);
                    const connectionX = inputX - Math.cos(angle) * inputRadius;
                    const connectionY = inputY - Math.sin(angle) * inputRadius;

                    // Draw line to circumference point
                    g.appendChild(this.line(pos.x, pos.y, connectionX, connectionY, '#e5e7eb', 1.5));
                });

                // Draw child nodes SECOND (middle layer)
                this.data.inputs.categories.forEach((cat, i) => {
                    if (i >= catPositions.length) return;
                    const pos = catPositions[i];
                    g.appendChild(this.circleNode(pos.x, pos.y, 28, cat.color, cat.id, cat.label.split(' ').slice(0, 2).join(' '), cat.items, false, '#f472b6'));
                });

                // Main input LAST (foreground)
                g.appendChild(this.circleNode(inputX, inputY, inputRadius, `url(#${this.type}Input)`, 'input', 'Input', this.data.inputs.main.description, true));

                this.svg.appendChild(g);
            }

            drawProcessor() {
                const g = this.createGroup('processor-layer');

                // Data processor repositioned to top of center sphere
                const procHex = this.hexPoints(260, 280, 60);
                g.appendChild(this.polygonNode(procHex, `url(#${this.type}Proc)`, 'processor', 'Data', 'processor', null, 'white', this.data.processor.description));

                this.svg.appendChild(g);
            }

            drawHypothesis() {
                const g = this.createGroup('hypothesis-layer');
                // Changed from triangle to circle/sphere
                g.appendChild(this.circleNode(260, 403, 35, '#d1d5db', 'hypothesis', 'Hypothesis', this.data.hypothesis.description, false, '#1f2937'));
                this.svg.appendChild(g);
            }

            drawSystems() {
                const g = this.createGroup('systems-layer');

                // System II (Left of center sphere)
                const sys2Hex = this.hexPoints(140, 390, 60);
                g.appendChild(this.polygonNode(sys2Hex, `url(#${this.type}Sys2)`, 'system2', this.data.systems.system2.label, this.data.systems.system2.sub, null, 'white', this.data.systems.system2.description));

                // System I (Right of center sphere)
                const sys1Hex = this.hexPoints(380, 390, 60);
                g.appendChild(this.polygonNode(sys1Hex, `url(#${this.type}Sys1)`, 'system1', this.data.systems.system1.label, this.data.systems.system1.sub, null, 'white', this.data.systems.system1.description));

                // Reflection node (Below center sphere) - hexagon, dark purple
                const reflectHex = this.hexPoints(260, 500, 60);
                g.appendChild(this.polygonNode(reflectHex, '#7c3aed', 'reflection', 'Reflection', '', '#6d28d9', 'white', this.data.systems.reflection.description));

                this.svg.appendChild(g);
            }

            drawOutputs() {
                const g = this.createGroup('outputs-layer');

                if (this.type === 'cdm') {
                    const planItems = this.data.outputs.planning.items;
                    const collItems = this.data.outputs.collection.items;

                    // Calculate card heights: title space + items
                    const planHeight = 30 + (planItems.length * 11);
                    const collHeight = 30 + (Math.min(collItems.length, 5) * 11);

                    // Draw planning card (background only, we'll add title and items separately)
                    const planRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    planRect.setAttribute('x', 75);
                    planRect.setAttribute('y', 705);
                    planRect.setAttribute('width', 125);
                    planRect.setAttribute('height', planHeight);
                    planRect.setAttribute('rx', 10);
                    planRect.setAttribute('fill', `url(#${this.type}Plan)`);
                    planRect.setAttribute('data-id', `${this.type}_planning`);
                    planRect.setAttribute('data-items', JSON.stringify(planItems));
                    planRect.classList.add('node-group');
                    g.appendChild(planRect);

                    // Planning title at top
                    g.appendChild(this.text(137, 720, this.data.outputs.planning.label, 10, 'rgba(255,255,255,0.95)', '700'));

                    // Planning items below title
                    planItems.forEach((item, i) => {
                        const txt = this.text(137, 735 + i * 11, item, 7, 'rgba(255,255,255,0.85)', '400');
                        txt.setAttribute('text-anchor', 'middle');
                        g.appendChild(txt);
                    });

                    // Draw collection card (background only)
                    const collRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    collRect.setAttribute('x', 320);
                    collRect.setAttribute('y', 705);
                    collRect.setAttribute('width', 125);
                    collRect.setAttribute('height', collHeight);
                    collRect.setAttribute('rx', 10);
                    collRect.setAttribute('fill', `url(#${this.type}Coll)`);
                    collRect.setAttribute('data-id', `${this.type}_collection`);
                    collRect.setAttribute('data-items', JSON.stringify(collItems));
                    collRect.classList.add('node-group');
                    g.appendChild(collRect);

                    // Collection title at top
                    g.appendChild(this.text(382, 720, this.data.outputs.collection.label, 10, 'rgba(255,255,255,0.95)', '700'));

                    // Collection items below title
                    collItems.slice(0, 5).forEach((item, i) => {
                        const displayText = item.length > 18 ? item.slice(0, 16) + '...' : item;
                        const txt = this.text(382, 735 + i * 11, displayText, 7, 'rgba(255,255,255,0.85)', '400');
                        txt.setAttribute('text-anchor', 'middle');
                        g.appendChild(txt);
                    });
                } else {
                    g.appendChild(this.rectNode(75, 705, 125, 55, 10, `url(#${this.type}Black)`, 'finalized', 'Finalized', this.data.outputs.finalized.description, 'Preference'));
                    g.appendChild(this.rectNode(320, 705, 125, 55, 10, `url(#${this.type}Black)`, 'seeking', 'Information', this.data.outputs.seeking.description, 'seeking'));
                    g.appendChild(this.text(260, 785, this.data.communication, 10, '#6b7280', '500'));
                }

                this.svg.appendChild(g);
            }

            drawPriors() {
                if (!this.data.priors) return;

                const g = this.createGroup('priors-layer');

                // Priors section on the RIGHT side, ABOVE Experience container
                const priorsBaseX = 475;  // Right side, aligned with Experience container
                const priorsBaseY = 160;  // Start higher, above Experience container
                const hexSize = 26;
                const hexSpacingX = 60;   // Horizontal spacing between hexagons
                const hexSpacingY = 52;   // Vertical spacing for honeycomb

                // "Priors" title - centered above hexagons
                g.appendChild(this.text(priorsBaseX, priorsBaseY - 25, this.data.priors.label, 12, '#6b7280', '700'));

                // "Bias" subtitle
                if (this.data.priors.sublabel) {
                    g.appendChild(this.text(priorsBaseX, priorsBaseY - 10, this.data.priors.sublabel, 9, '#9ca3af', '500', '', 'italic'));
                }

                // Draw prior knowledge hexagons in HONEYCOMB pattern on RIGHT
                // Honeycomb arrangement for 4 items:
                //     hex0    hex1
                //   hex2    hex3
                const honeycombPositions = [
                    { x: priorsBaseX - hexSpacingX/2, y: priorsBaseY },           // Top left
                    { x: priorsBaseX + hexSpacingX/2, y: priorsBaseY },           // Top right
                    { x: priorsBaseX - hexSpacingX/2, y: priorsBaseY + hexSpacingY },  // Bottom left
                    { x: priorsBaseX + hexSpacingX/2, y: priorsBaseY + hexSpacingY }   // Bottom right
                ];

                this.data.priors.items.forEach((prior, i) => {
                    if (i >= honeycombPositions.length) return;
                    const pos = honeycombPositions[i];
                    const hexPts = this.hexPoints(pos.x, pos.y, hexSize);
                    g.appendChild(this.polygonNode(hexPts, '#f3f4f6', prior.id, prior.label, prior.sub || '', '#e5e7eb', '#6b7280', prior.description, 7));
                });

                this.svg.appendChild(g);
            }

            drawRefinementLoop() {
                const g = this.createGroup('experience-storage-layer');

                // Storage container position (lowered from 300 to 400)
                const containerX = 440;
                const containerY = 400;
                const containerWidth = 70;
                const containerHeight = 220;

                // Draw storage container (database-like cylinder)
                const container = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                container.setAttribute('x', containerX);
                container.setAttribute('y', containerY);
                container.setAttribute('width', containerWidth);
                container.setAttribute('height', containerHeight);
                container.setAttribute('rx', '8');
                container.setAttribute('fill', 'rgba(139, 92, 246, 0.08)');
                container.setAttribute('stroke', '#8b5cf6');
                container.setAttribute('stroke-width', '2');
                container.setAttribute('stroke-dasharray', '4,3');
                g.appendChild(container);

                // Top ellipse for cylinder effect
                const ellipse = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                ellipse.setAttribute('cx', containerX + containerWidth/2);
                ellipse.setAttribute('cy', containerY);
                ellipse.setAttribute('rx', containerWidth/2);
                ellipse.setAttribute('ry', '8');
                ellipse.setAttribute('fill', 'rgba(139, 92, 246, 0.15)');
                ellipse.setAttribute('stroke', '#8b5cf6');
                ellipse.setAttribute('stroke-width', '2');
                g.appendChild(ellipse);

                // Storage icon
                const iconY = containerY + 20;
                const dbIcon = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                dbIcon.innerHTML = `
                    <circle cx="${containerX + containerWidth/2}" cy="${iconY}" r="8" fill="#8b5cf6" opacity="0.3"/>
                    <text x="${containerX + containerWidth/2}" y="${iconY}" font-size="10" fill="#6d28d9" font-weight="700" text-anchor="middle" dominant-baseline="middle">M</text>
                `;
                g.appendChild(dbIcon);

                // Title
                const title = this.text(containerX + containerWidth/2, containerY + 45, 'Experience', 8, '#6d28d9', '700');
                g.appendChild(title);

                const title2 = this.text(containerX + containerWidth/2, containerY + 57, '& Learning', 8, '#6d28d9', '700');
                g.appendChild(title2);

                // Storage items
                const items = ['Retrieval', 'Analysis', 'Calibrate'];
                const itemY = containerY + 85;
                const itemSpacing = 35;

                items.forEach((label, i) => {
                    const y = itemY + (i * itemSpacing);

                    // Item background
                    const itemBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    itemBg.setAttribute('x', containerX + 8);
                    itemBg.setAttribute('y', y - 10);
                    itemBg.setAttribute('width', containerWidth - 16);
                    itemBg.setAttribute('height', 22);
                    itemBg.setAttribute('rx', '4');
                    itemBg.setAttribute('fill', 'rgba(139, 92, 246, 0.12)');
                    g.appendChild(itemBg);

                    // Item label
                    const txt = this.text(containerX + containerWidth/2, y, label, 7, '#6d28d9', '600');
                    g.appendChild(txt);

                    // Small dot indicator
                    g.appendChild(this.simpleCircle(containerX + 15, y, 2, '#8b5cf6', 'none', 0));
                });

                this.svg.appendChild(g);
            }

            // Helpers
            createGroup(className) {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', className);
                return g;
            }

            createPath(d, stroke, width, marker = null, animated = false, className = '', dasharray = null, opacity = 1) {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', d);
                path.setAttribute('stroke', stroke);
                path.setAttribute('stroke-width', width);
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke-linecap', 'round');
                if (marker) path.setAttribute('marker-end', marker);
                if (animated) path.setAttribute('class', className || 'flow-path animated');
                if (dasharray) path.setAttribute('stroke-dasharray', dasharray);
                if (opacity !== 1) path.setAttribute('opacity', opacity);
                return path;
            }

            line(x1, y1, x2, y2, stroke, width) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', stroke);
                line.setAttribute('stroke-width', width);
                return line;
            }

            text(x, y, content, size, fill, weight = '400', transform = null) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', y);
                text.setAttribute('font-size', size);
                text.setAttribute('fill', fill);
                text.setAttribute('font-weight', weight);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('class', 'node-text');
                if (transform) text.setAttribute('transform', transform);
                text.textContent = content;
                return text;
            }

            simpleCircle(cx, cy, r, fill, stroke, strokeWidth) {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', cx);
                circle.setAttribute('cy', cy);
                circle.setAttribute('r', r);
                circle.setAttribute('fill', fill);
                circle.setAttribute('stroke', stroke);
                circle.setAttribute('stroke-width', strokeWidth);
                return circle;
            }

            circleNode(cx, cy, r, fill, id, label, items = null, showGlow = false, stroke = null) {
                const g = this.createGroup('node-group');
                g.setAttribute('data-id', `${this.type}_${id}`);
                if (items) g.setAttribute('data-items', JSON.stringify(items));

                if (showGlow) {
                    const glow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    glow.setAttribute('cx', cx);
                    glow.setAttribute('cy', cy);
                    glow.setAttribute('r', r + 10);
                    glow.setAttribute('fill', 'none');
                    glow.setAttribute('stroke', '#db2777');
                    glow.setAttribute('stroke-width', '3');
                    glow.setAttribute('opacity', '0');
                    glow.setAttribute('class', 'glow-effect');
                    g.appendChild(glow);
                }

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', cx);
                circle.setAttribute('cy', cy);
                circle.setAttribute('r', r);
                circle.setAttribute('fill', fill);
                if (stroke) {
                    circle.setAttribute('stroke', stroke);
                    circle.setAttribute('stroke-width', '2');
                }
                g.appendChild(circle);

                const textColor = stroke ? '#1f2937' : 'white';
                g.appendChild(this.text(cx, cy, label, r < 32 ? 8 : 12, textColor, '600'));

                return g;
            }

            polygonNode(points, fill, id, label, sublabel = '', stroke = null, textColor = 'white', items = null, fontSize = null) {
                const g = this.createGroup('node-group');
                g.setAttribute('data-id', `${this.type}_${id}`);
                if (items && items.length) g.setAttribute('data-items', JSON.stringify(items));

                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                polygon.setAttribute('points', points);
                polygon.setAttribute('fill', fill);
                if (stroke) {
                    polygon.setAttribute('stroke', stroke);
                    polygon.setAttribute('stroke-width', '2');
                }
                g.appendChild(polygon);

                const pts = points.split(' ').map(p => p.split(',').map(Number));
                const cx = pts.reduce((s, p) => s + p[0], 0) / pts.length;
                const cy = pts.reduce((s, p) => s + p[1], 0) / pts.length;

                const labelSize = fontSize || (label.length > 14 ? 8 : 10);
                g.appendChild(this.text(cx, sublabel ? cy - 7 : cy, label, labelSize, textColor, '600'));
                if (sublabel) {
                    g.appendChild(this.text(cx, cy + 8, sublabel, labelSize, textColor === 'white' ? 'rgba(255,255,255,0.8)' : '#78716c', '600'));
                }

                return g;
            }

            rectNode(x, y, w, h, rx, fill, id, label, items = null, sublabel = '') {
                const g = this.createGroup('node-group');
                g.setAttribute('data-id', `${this.type}_${id}`);
                if (items && items.length) g.setAttribute('data-items', JSON.stringify(items));

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', w);
                rect.setAttribute('height', h);
                rect.setAttribute('rx', rx);
                rect.setAttribute('fill', fill);
                g.appendChild(rect);

                g.appendChild(this.text(x + w/2, sublabel ? y + h/2 - 8 : y + h/2, label, 11, 'white', '600'));
                if (sublabel) {
                    g.appendChild(this.text(x + w/2, y + h/2 + 8, sublabel, 9, 'rgba(255,255,255,0.8)', '400'));
                }

                return g;
            }

            hexPoints(cx, cy, r) {
                const pts = [];
                for (let i = 0; i < 6; i++) {
                    const angle = (Math.PI / 3) * i - Math.PI / 2;
                    pts.push(`${(cx + r * Math.cos(angle)).toFixed(1)},${(cy + r * Math.sin(angle)).toFixed(1)}`);
                }
                return pts.join(' ');
            }

            setActive(stageId) {
                // Clear previous active states
                this.svg.querySelectorAll('.node-group.active').forEach(n => n.classList.remove('active'));
                this.svg.querySelectorAll('.path-active').forEach(p => p.classList.remove('path-active'));

                // Set active node
                const node = this.svg.querySelector(`[data-id="${this.type}_${stageId}"]`);
                if (node) {
                    node.classList.add('active');

                    // Highlight active path based on stage
                    const pathMap = {
                        'input': 'path-input-processor',
                        'processor': 'path-processor-hypothesis',
                        'hypothesis': ['path-hypothesis-sys2', 'path-hypothesis-sys1'],
                        'system2': 'path-triangle-reflection',
                        'system1': 'path-triangle-reflection',
                        'reflection': ['path-reflection-planning', 'path-reflection-collection'],
                        'planning': null,
                        'collection': null,
                        'finalized': null,
                        'seeking': null
                    };

                    const pathIds = pathMap[stageId];
                    if (pathIds) {
                        const ids = Array.isArray(pathIds) ? pathIds : [pathIds];
                        ids.forEach(pathId => {
                            const path = this.svg.querySelector(`#${pathId}`);
                            if (path) {
                                path.classList.add('path-active');
                            }
                        });
                    }
                }
            }
        }

        // ============================================
        // ANIMATION CONTROLLER
        // ============================================

        class AnimationController {
            constructor() {
                this.cdmRenderer = null;
                this.pdmRenderer = null;
                this.isPlaying = false;
                this.isSynced = false;
                this.speed = 1;
                this.stageIndex = 0;
                this.loopCount = 1;
                this.timeout = null;

                this.stages = [
                    { id: 'input', label: 'Input Integration', duration: 1600 },
                    { id: 'processor', label: 'Data Processing', duration: 2000 },
                    { id: 'hypothesis', label: 'Hypothesis Formation', duration: 1800 },
                    { id: 'system2', label: 'System II: Analytical', duration: 2200 },
                    { id: 'system1', label: 'System I: Intuition', duration: 1800 },
                    { id: 'reflection', label: 'Reflection', duration: 2500 },
                    { id: 'decision', label: 'Decision Point', duration: 1200 }
                ];

                this.init();
            }

            init() {
                // Check if SVG elements exist before initializing
                const cdmSvg = document.getElementById('cdmSvg');
                const pdmSvg = document.getElementById('pdmSvg');

                if (!cdmSvg || !pdmSvg) {
                    console.warn('Decision making SVG elements not found. Skipping initialization.');
                    return;
                }

                this.cdmRenderer = new FlowRenderer(cdmSvg, CDM_DATA, 'cdm');
                this.pdmRenderer = new FlowRenderer(pdmSvg, PDM_DATA, 'pdm');

                this.populateLegend();
                this.setupControls();
                this.setupTooltips();

                lucide.createIcons();
                this.play();
            }

            populateLegend() {
                const grid = document.getElementById('legendGrid');
                if (!grid) return;

                LEGEND_DATA.forEach(item => {
                    grid.innerHTML += `
                        <div class="legend-item">
                            <div class="legend-swatch" style="background:${item.color}"></div>
                            <span class="legend-label">${item.label}</span>
                        </div>
                    `;
                });
            }

            setupControls() {
                const playBtn = document.getElementById('playBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const resetBtn = document.getElementById('resetBtn');
                const syncBtn = document.getElementById('syncBtn');
                const interactionHub = document.getElementById('interactionHub');
                const speedSlider = document.getElementById('speedSlider');

                if (playBtn) playBtn.onclick = () => this.play();
                if (pauseBtn) pauseBtn.onclick = () => this.pause();
                if (resetBtn) resetBtn.onclick = () => this.reset();
                if (syncBtn) syncBtn.onclick = () => this.toggleSync();
                if (interactionHub) interactionHub.onclick = () => this.toggleSync();
                if (speedSlider) speedSlider.oninput = (e) => this.speed = parseFloat(e.target.value);
            }

            setupTooltips() {
                const tooltip = document.getElementById('dmTooltip');
                if (!tooltip) return;

                document.querySelectorAll('.node-group').forEach(node => {
                    node.addEventListener('mouseenter', () => {
                        const id = node.getAttribute('data-id');
                        const items = node.getAttribute('data-items');

                        if (id) {
                            const label = id.split('_').slice(1).join(' ').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            const header = tooltip.querySelector('.dm-tooltip-header');
                            if (header) header.textContent = label;

                            const list = tooltip.querySelector('.dm-tooltip-list');
                            if (list) {
                                list.innerHTML = '';
                                if (items) {
                                    JSON.parse(items).forEach(item => {
                                        list.innerHTML += `<li>${item}</li>`;
                                    });
                                }
                            }

                            tooltip.classList.add('visible');
                        }
                    });

                    node.addEventListener('mousemove', (e) => {
                        tooltip.style.left = e.clientX + 15 + 'px';
                        tooltip.style.top = e.clientY + 15 + 'px';
                    });

                    node.addEventListener('mouseleave', () => {
                        tooltip.classList.remove('visible');
                    });
                });
            }

            play() {
                this.isPlaying = true;
                this.updateButtons();
                this.runAnimation();
            }

            pause() {
                this.isPlaying = false;
                this.updateButtons();
                clearTimeout(this.timeout);
            }

            reset() {
                this.pause();
                this.stageIndex = 0;
                this.loopCount = 1;
                this.updateLoops();
                this.updateStage('Awaiting Input');
                if (this.cdmRenderer) this.cdmRenderer.setActive('input');
                if (this.pdmRenderer) this.pdmRenderer.setActive('input');
            }

            toggleSync() {
                this.isSynced = !this.isSynced;
                const interactionHub = document.getElementById('interactionHub');
                const syncBtn = document.getElementById('syncBtn');
                if (interactionHub) interactionHub.classList.toggle('synced', this.isSynced);
                if (syncBtn) syncBtn.classList.toggle('active', this.isSynced);
            }

            updateButtons() {
                const playBtn = document.getElementById('playBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                if (playBtn) playBtn.classList.toggle('active', this.isPlaying);
                if (pauseBtn) pauseBtn.classList.toggle('active', !this.isPlaying);
            }

            runAnimation() {
                if (!this.isPlaying) return;

                const stage = this.stages[this.stageIndex];
                this.updateStage(stage.label);
                if (this.cdmRenderer) this.cdmRenderer.setActive(stage.id);

                if (this.isSynced) {
                    if (this.pdmRenderer) this.pdmRenderer.setActive(stage.id);
                } else {
                    setTimeout(() => {
                        if (this.isPlaying && this.pdmRenderer) this.pdmRenderer.setActive(stage.id);
                    }, 350);
                }

                if (stage.id === 'decision') {
                    const shouldLoop = this.loopCount < 4 && Math.random() > 0.55;

                    if (shouldLoop) {
                        this.loopCount++;
                        this.updateLoops();
                        this.stageIndex = 1;
                        this.updateStage('Iterating: Re-processing');
                    } else {
                        const goToPlanning = Math.random() > 0.35;

                        if (goToPlanning) {
                            if (this.cdmRenderer) this.cdmRenderer.setActive('planning');
                            if (this.pdmRenderer) this.pdmRenderer.setActive('finalized');
                            this.updateStage('Action: Planning Complete');

                            this.timeout = setTimeout(() => {
                                this.reset();
                                this.play();
                            }, 5000 / this.speed);
                            return;
                        } else {
                            if (this.cdmRenderer) this.cdmRenderer.setActive('collection');
                            if (this.pdmRenderer) this.pdmRenderer.setActive('seeking');
                            this.updateStage('Collecting More Data');

                            this.timeout = setTimeout(() => {
                                this.loopCount++;
                                if (this.loopCount > 4) this.loopCount = 1;
                                this.updateLoops();
                                this.stageIndex = 0;
                                if (this.isPlaying) this.runAnimation();
                            }, 2500 / this.speed);
                            return;
                        }
                    }
                } else {
                    this.stageIndex = (this.stageIndex + 1) % this.stages.length;
                }

                this.timeout = setTimeout(() => {
                    if (this.isPlaying) this.runAnimation();
                }, stage.duration / this.speed);
            }

            updateStage(label) {
                const cdmStageText = document.getElementById('cdmStageText');
                const pdmStageText = document.getElementById('pdmStageText');
                if (cdmStageText) cdmStageText.textContent = label;
                if (pdmStageText) pdmStageText.textContent = label;
            }

            updateLoops() {
                ['cdm', 'pdm'].forEach(type => {
                    const dots = document.querySelectorAll(`#${type}LoopDots .loop-dot`);
                    dots.forEach((dot, i) => {
                        dot.classList.toggle('active', i < this.loopCount);
                    });
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new AnimationController();
        });
    </script>
</body>
</html>